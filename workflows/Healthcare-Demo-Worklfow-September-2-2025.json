{
  "name": "Healthcare-Demo-Worklfow-September-2-2025",
  "nodes": [
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        496,
        -48
      ],
      "id": "9738a87b-1baa-4abd-afe5-37377e65e0ec",
      "name": "Chat Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        208,
        -240
      ],
      "id": "d327d235-9396-4aeb-bc76-b8b36e562251",
      "name": "Demo Creation Response"
    },
    {
      "parameters": {
        "jsCode": "// Complete State Manager - PERMANENT SOLUTION\nconst input = $input.first().json;\nconst message = input.message || '';\nlet demoContext = input.demoContext || {};\n\n// Get current state from input or default to initial\nlet currentState = input.currentState || 'initial';\nlet collectedData = input.collectedData || {};\nlet bookingState = input.bookingState || '';\nlet bookingData = input.bookingData || {};\n\n// PERMANENT SOLUTION: Use demo context directly from input\nif (input.demoContext && input.demoContext.companyName) {\n  demoContext = input.demoContext;\n  console.log(' Using demo context from input:', demoContext.companyName);\n  console.log(' Agent Name:', demoContext.agentName);\n} else {\n  console.log('‚ùå No demo context found in input');\n}\n\n// Merge collectedData with bookingData if available\nif (bookingData && Object.keys(bookingData).length > 0) {\n  collectedData = { ...collectedData, ...bookingData };\n}\n\nconsole.log('üîß Input received:', JSON.stringify(input, null, 2));\nconsole.log('üîß Current State:', currentState);\nconsole.log(' Message:', message);\nconsole.log('üîß Demo Context:', demoContext.companyName);\nconsole.log(' Agent Name:', demoContext.agentName);\nconsole.log('üîß Collected Data:', collectedData);\nconsole.log('üîß Booking State:', bookingState);\nconsole.log('üîß Booking Data:', bookingData);\n\n// Helper function to get random response from array\nfunction getRandomResponse(responses) {\n  const randomIndex = Math.floor(Math.random() * responses.length);\n  return responses[randomIndex];\n}\n\n// Simple state machine with demo context\nlet response = '';\nlet nextState = currentState;\nlet highlightedText = [];\nlet quickActions = [];\n\nswitch (currentState) {\n  case 'initial':\n    if (message.toLowerCase().includes('appointment') || message.toLowerCase().includes('book') || message.toLowerCase().includes('schedule')) {\n      const greetings = [\n        `Absolutely! I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'd be happy to help you schedule your appointment. I'm here to make this process as smooth and comfortable as possible for you. Are you a new patient or an existing patient?`,\n        `Of course! I'd love to help you get your appointment scheduled. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to take care of everything for you. Are you a new patient or an existing patient?`,\n        `Wonderful! I'm so glad you reached out. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to help you get your appointment scheduled right away. Are you a new patient or an existing patient?`,\n        `I'm delighted to help you schedule your appointment! I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to make sure you get the care you need. Are you a new patient or an existing patient?`,\n        `Absolutely! Let's get your appointment scheduled. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to help you every step of the way. Are you a new patient or an existing patient?`,\n        `Perfect! I'm excited to help you schedule your appointment. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to make this booking process simple and stress-free. Are you a new patient or an existing patient?`,\n        `Excellent! I'd be honored to help you schedule your appointment. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to ensure you get the care you deserve. Are you a new patient or an existing patient?`,\n        `Fantastic! I'm here to help you schedule your appointment. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm committed to making this process as easy as possible for you. Are you a new patient or an existing patient?`,\n        `Great! I'm thrilled to assist you with scheduling your appointment. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm here to guide you through every step. Are you a new patient or an existing patient?`,\n        `Wonderful! I'm here to help you schedule your appointment. I'm ${demoContext.agentName} from ${demoContext.companyName}, and I'm dedicated to making this experience smooth and comfortable for you. Are you a new patient or an existing patient?`\n      ];\n      \n      response = getRandomResponse(greetings);\n      nextState = 'waiting_for_patient_type';\n      highlightedText = ['new patient or an existing patient'];\n      quickActions = [\n        { text: 'New Patient', action: 'new' },\n        { text: 'Existing Patient', action: 'existing' }\n      ];\n    } else {\n      const welcomeMessages = [\n        `Hello! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to help. Would you like to schedule an appointment?`,\n        `Hi there! I'm ${demoContext.agentName} from ${demoContext.companyName}. How can I assist you today? Would you like to schedule an appointment?`,\n        `Good day! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to help. Is there an appointment you'd like to schedule?`,\n        `Welcome! I'm ${demoContext.agentName} from ${demoContext.companyName}. How may I help you today? Would you like to book an appointment?`,\n        `Greetings! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to assist you. Are you looking to schedule an appointment?`,\n        `Hello and welcome! I'm ${demoContext.agentName} from ${demoContext.companyName}. How can I help you today? Would you like to make an appointment?`,\n        `Hi! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to support you. Is scheduling an appointment what you need?`,\n        `Good to see you! I'm ${demoContext.agentName} from ${demoContext.companyName}. How may I be of service? Would you like to schedule an appointment?`,\n        `Welcome! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to help. Are you interested in booking an appointment?`,\n        `Hello there! I'm ${demoContext.agentName} from ${demoContext.companyName}. How can I assist you today? Would you like to schedule an appointment?`\n      ];\n      \n      response = getRandomResponse(welcomeMessages);\n      nextState = 'initial';\n      quickActions = [\n        { text: 'Schedule Appointment', action: 'schedule' }\n      ];\n    }\n    break;\n    \n  case 'waiting_for_patient_type':\n    if (message.toLowerCase().includes('new') || message.toLowerCase().includes('new patient')) {\n      const newPatientResponses = [\n        `Great! I'll need some information to schedule your appointment. What is your First Name and Last Name?`,\n        `Excellent! To get your appointment scheduled, I'll need a few details. What is your First Name and Last Name?`,\n        `Perfect! Let me gather some information to book your appointment. What is your First Name and Last Name?`,\n        `Wonderful! I'll need some basic information to schedule your visit. What is your First Name and Last Name?`,\n        `Fantastic! To set up your appointment, I need a few details. What is your First Name and Last Name?`,\n        `Great choice! I'll need some information to get your appointment booked. What is your First Name and Last Name?`,\n        `Excellent! Let me collect some details to schedule your appointment. What is your First Name and Last Name?`,\n        `Perfect! I'll need some information to book your visit. What is your First Name and Last Name?`,\n        `Wonderful! To schedule your appointment, I need a few details. What is your First Name and Last Name?`,\n        `Great! Let me gather some information to set up your appointment. What is your First Name and Last Name?`\n      ];\n      \n      response = getRandomResponse(newPatientResponses);\n      nextState = 'waiting_for_name';\n      highlightedText = ['First Name and Last Name'];\n      quickActions = [];\n    } else if (message.toLowerCase().includes('existing') || message.toLowerCase().includes('existing patient')) {\n      const existingPatientResponses = [\n        `Welcome back! I'll need some information to schedule your appointment. What is your First Name and Last Name?`,\n        `Great to see you again! To schedule your appointment, I need a few details. What is your First Name and Last Name?`,\n        `Welcome back! I'll need some information to book your visit. What is your First Name and Last Name?`,\n        `So glad you're returning! To schedule your appointment, I need some details. What is your First Name and Last Name?`,\n        `Welcome back! I'll need a few details to schedule your appointment. What is your First Name and Last Name?`,\n        `Great to have you back! To book your appointment, I need some information. What is your First Name and Last Name?`,\n        `Welcome back! I'll need some details to schedule your visit. What is your First Name and Last Name?`,\n        `So happy you're returning! To schedule your appointment, I need some information. What is your First Name and Last Name?`,\n        `Welcome back! I'll need a few details to book your appointment. What is your First Name and Last Name?`,\n        `Great to see you again! To schedule your appointment, I need some details. What is your First Name and Last Name?`\n      ];\n      \n      response = getRandomResponse(existingPatientResponses);\n      nextState = 'waiting_for_name';\n      highlightedText = ['First Name and Last Name'];\n      quickActions = [];\n    } else {\n      const clarificationResponses = [\n        `Please let me know if you're a new patient or an existing patient.`,\n        `Could you clarify whether you're a new patient or an existing patient?`,\n        `I need to know if you're a new patient or an existing patient.`,\n        `Please specify if you're a new patient or an existing patient.`,\n        `Could you tell me if you're a new patient or an existing patient?`,\n        `I'd like to know if you're a new patient or an existing patient.`,\n        `Please indicate whether you're a new patient or an existing patient.`,\n        `Could you clarify if you're a new patient or an existing patient?`,\n        `I need to know whether you're a new patient or an existing patient.`,\n        `Please specify whether you're a new patient or an existing patient.`\n      ];\n      \n      response = getRandomResponse(clarificationResponses);\n      nextState = 'waiting_for_patient_type';\n      quickActions = [\n        { text: 'New Patient', action: 'new' },\n        { text: 'Existing Patient', action: 'existing' }\n      ];\n    }\n    break;\n    \n  case 'waiting_for_name':\n    const nameMatch = message.match(/^([A-Za-z]+)\\s+([A-Za-z]+)$/);\n    if (nameMatch) {\n      collectedData.firstName = nameMatch[1];\n      collectedData.lastName = nameMatch[2];\n      \n      const dobResponses = [\n        `Thank you ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Perfect ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Great ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Excellent ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Wonderful ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Fantastic ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Thanks ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Perfect ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Great ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`,\n        `Excellent ${collectedData.firstName}! What is your Date of Birth? (Example: MM/DD/YYYY)`\n      ];\n      \n      response = getRandomResponse(dobResponses);\n      nextState = 'waiting_for_dob';\n      highlightedText = ['Date of Birth'];\n      quickActions = [];\n    } else {\n      const nameClarificationResponses = [\n        `Please provide your First Name and Last Name (e.g., John Smith).`,\n        `Could you give me your First Name and Last Name (e.g., John Smith)?`,\n        `I need your First Name and Last Name (e.g., John Smith).`,\n        `Please share your First Name and Last Name (e.g., John Smith).`,\n        `Could you provide your First Name and Last Name (e.g., John Smith)?`,\n        `I'd like your First Name and Last Name (e.g., John Smith).`,\n        `Please give me your First Name and Last Name (e.g., John Smith).`,\n        `Could you share your First Name and Last Name (e.g., John Smith)?`,\n        `I need your First Name and Last Name (e.g., John Smith).`,\n        `Please provide your First Name and Last Name (e.g., John Smith).`\n      ];\n      \n      response = getRandomResponse(nameClarificationResponses);\n      nextState = 'waiting_for_name';\n      quickActions = [];\n    }\n    break;\n    \n  case 'waiting_for_dob':\n    // Validate date of birth format (MM/DD/YYYY or MM-DD-YYYY)\n    const dobPattern = /^(0[1-9]|1[0-2])\\/(0[1-9]|[12]\\d|3[01])\\/(19|20)\\d{2}$|^(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])-(19|20)\\d{2}$/;\n    if (dobPattern.test(message)) {\n      collectedData.dateOfBirth = message;\n      \n      const phoneResponses = [\n        `Thank you! What is your phone number? (Example: 555-123-4567)`,\n        `Perfect! What is your phone number? (Example: 555-123-4567)`,\n        `Great! What is your phone number? (Example: 555-123-4567)`,\n        `Excellent! What is your phone number? (Example: 555-123-4567)`,\n        `Wonderful! What is your phone number? (Example: 555-123-4567)`,\n        `Fantastic! What is your phone number? (Example: 555-123-4567)`,\n        `Thanks! What is your phone number? (Example: 555-123-4567)`,\n        `Perfect! What is your phone number? (Example: 555-123-4567)`,\n        `Great! What is your phone number? (Example: 555-123-4567)`,\n        `Excellent! What is your phone number? (Example: 555-123-4567)`\n      ];\n      \n      response = getRandomResponse(phoneResponses);\n      nextState = 'waiting_for_phone';\n      highlightedText = ['phone number'];\n      quickActions = [];\n    } else {\n      const dobClarificationResponses = [\n        `Please provide your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`,\n        `Could you give me your date of birth in MM/DD/YYYY format (e.g., 01/15/1985)?`,\n        `I need your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`,\n        `Please share your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`,\n        `Could you provide your date of birth in MM/DD/YYYY format (e.g., 01/15/1985)?`,\n        `I'd like your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`,\n        `Please give me your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`,\n        `Could you share your date of birth in MM/DD/YYYY format (e.g., 01/15/1985)?`,\n        `I need your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`,\n        `Please provide your date of birth in MM/DD/YYYY format (e.g., 01/15/1985).`\n      ];\n      \n      response = getRandomResponse(dobClarificationResponses);\n      nextState = 'waiting_for_dob';\n      quickActions = [];\n    }\n    break;\n    \n  case 'waiting_for_phone':\n    // Get user's country from demo context or default to US\n    const userCountry = demoContext.userCountry || 'US';\n    \n    // Phone number validation patterns for different countries\n    const phonePatterns = {\n      'US': /^(\\+?1[-.]?)?\\(?([0-9]{3})\\)?[-.]?([0-9]{3})[-.]?([0-9]{4})$|^([0-9]{10})$/,\n      'CA': /^(\\+?1[-.]?)?\\(?([0-9]{3})\\)?[-.]?([0-9]{3})[-.]?([0-9]{4})$|^([0-9]{10})$/,\n      'GB': /^(\\+?44[-.]?)?([0-9]{4,5})[-.]?([0-9]{6})$/,\n      'AU': /^(\\+?61[-.]?)?([0-9]{1})[-.]?([0-9]{4})[-.]?([0-9]{4})$/,\n      'DE': /^(\\+?49[-.]?)?([0-9]{3,5})[-.]?([0-9]{6,8})$/,\n      'FR': /^(\\+?33[-.]?)?([0-9]{1})[-.]?([0-9]{2})[-.]?([0-9]{2})[-.]?([0-9]{2})[-.]?([0-9]{2})$/,\n      'IN': /^(\\+?91[-.]?)?([0-9]{5})[-.]?([0-9]{5})$/,\n      'JP': /^(\\+?81[-.]?)?([0-9]{2})[-.]?([0-9]{4})[-.]?([0-9]{4})$/,\n      'CN': /^(\\+?86[-.]?)?([0-9]{3})[-.]?([0-9]{4})[-.]?([0-9]{4})$/,\n      'BR': /^(\\+?55[-.]?)?([0-9]{2})[-.]?([0-9]{5})[-.]?([0-9]{4})$/,\n      'MX': /^(\\+?52[-.]?)?([0-9]{3})[-.]?([0-9]{3})[-.]?([0-9]{4})$/,\n      'default': /^(\\+?[0-9]{1,4}[-.]?)?([0-9]{7,15})$\n    };\n    \n    const phonePattern = phonePatterns[userCountry] || phonePatterns['default'];\n    const cleanMessage = message.replace(/[\\s\\-\\(\\)]/g, '');\n    \n    if (phonePattern.test(cleanMessage)) {\n      // Format phone number based on country\n      let formattedPhone = message;\n      \n      // Auto-format based on country\n      switch (userCountry) {\n        case 'US':\n        case 'CA':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+1 (${cleanMessage.slice(0, 3)}) ${cleanMessage.slice(3, 6)}-${cleanMessage.slice(6)}`;\n          } else if (cleanMessage.startsWith('1') && cleanMessage.length === 11) {\n            formattedPhone = `+1 (${cleanMessage.slice(1, 4)}) ${cleanMessage.slice(4, 7)}-${cleanMessage.slice(7)}`;\n          }\n          break;\n        case 'GB':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+44 ${cleanMessage.slice(0, 4)} ${cleanMessage.slice(4)}`;\n          } else if (cleanMessage.startsWith('44') && cleanMessage.length === 12) {\n            formattedPhone = `+44 ${cleanMessage.slice(2, 6)} ${cleanMessage.slice(6)}`;\n          }\n          break;\n        case 'AU':\n          if (cleanMessage.length === 9) {\n            formattedPhone = `+61 ${cleanMessage.slice(0, 1)} ${cleanMessage.slice(1, 5)} ${cleanMessage.slice(5)}`;\n          } else if (cleanMessage.startsWith('61') && cleanMessage.length === 11) {\n            formattedPhone = `+61 ${cleanMessage.slice(2, 3)} ${cleanMessage.slice(3, 7)} ${cleanMessage.slice(7)}`;\n          }\n          break;\n        case 'DE':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+49 ${cleanMessage.slice(0, 3)} ${cleanMessage.slice(3)}`;\n          } else if (cleanMessage.startsWith('49') && cleanMessage.length === 12) {\n            formattedPhone = `+49 ${cleanMessage.slice(2, 5)} ${cleanMessage.slice(5)}`;\n          }\n          break;\n        case 'FR':\n          if (cleanMessage.length === 9) {\n            formattedPhone = `+33 ${cleanMessage.slice(0, 1)} ${cleanMessage.slice(1, 3)} ${cleanMessage.slice(3, 5)} ${cleanMessage.slice(5, 7)} ${cleanMessage.slice(7)}`;\n          } else if (cleanMessage.startsWith('33') && cleanMessage.length === 11) {\n            formattedPhone = `+33 ${cleanMessage.slice(2, 3)} ${cleanMessage.slice(3, 5)} ${cleanMessage.slice(5, 7)} ${cleanMessage.slice(7, 9)} ${cleanMessage.slice(9)}`;\n          }\n          break;\n        case 'IN':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+91 ${cleanMessage.slice(0, 5)} ${cleanMessage.slice(5)}`;\n          } else if (cleanMessage.startsWith('91') && cleanMessage.length === 12) {\n            formattedPhone = `+91 ${cleanMessage.slice(2, 7)} ${cleanMessage.slice(7)}`;\n          }\n          break;\n        case 'JP':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+81 ${cleanMessage.slice(0, 2)} ${cleanMessage.slice(2, 6)} ${cleanMessage.slice(6)}`;\n          } else if (cleanMessage.startsWith('81') && cleanMessage.length === 12) {\n            formattedPhone = `+81 ${cleanMessage.slice(2, 4)} ${cleanMessage.slice(4, 8)} ${cleanMessage.slice(8)}`;\n          }\n          break;\n        case 'CN':\n          if (cleanMessage.length === 11) {\n            formattedPhone = `+86 ${cleanMessage.slice(0, 3)} ${cleanMessage.slice(3, 7)} ${cleanMessage.slice(7)}`;\n          } else if (cleanMessage.startsWith('86') && cleanMessage.length === 13) {\n            formattedPhone = `+86 ${cleanMessage.slice(2, 5)} ${cleanMessage.slice(5, 9)} ${cleanMessage.slice(9)}`;\n          }\n          break;\n        case 'BR':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+55 ${cleanMessage.slice(0, 2)} ${cleanMessage.slice(2, 7)} ${cleanMessage.slice(7)}`;\n          } else if (cleanMessage.startsWith('55') && cleanMessage.length === 12) {\n            formattedPhone = `+55 ${cleanMessage.slice(2, 4)} ${cleanMessage.slice(4, 9)} ${cleanMessage.slice(9)}`;\n          }\n          break;\n        case 'MX':\n          if (cleanMessage.length === 10) {\n            formattedPhone = `+52 ${cleanMessage.slice(0, 3)} ${cleanMessage.slice(3, 6)} ${cleanMessage.slice(6)}`;\n          } else if (cleanMessage.startsWith('52') && cleanMessage.length === 12) {\n            formattedPhone = `+52 ${cleanMessage.slice(2, 5)} ${cleanMessage.slice(5, 8)} ${cleanMessage.slice(8)}`;\n          }\n          break;\n        default:\n          // For other countries, just add the appropriate dial code\n          const dialCodes = {\n            'ES': '+34', 'IT': '+39', 'NL': '+31', 'SE': '+46', 'NO': '+47', 'DK': '+45',\n            'FI': '+358', 'PL': '+48', 'RU': '+7', 'KR': '+82', 'SG': '+65', 'MY': '+60',\n            'TH': '+66', 'VN': '+84', 'PH': '+63', 'ID': '+62', 'TR': '+90', 'SA': '+966',\n            'AE': '+971', 'IL': '+972', 'ZA': '+27', 'EG': '+20', 'NG': '+234', 'KE': '+254'\n          };\n          const dialCode = dialCodes[userCountry] || '+1';\n          formattedPhone = `${dialCode} ${cleanMessage}`;\n      }\n      \n      collectedData.phone = formattedPhone;\n      \n      const emailResponses = [\n        `Great! What is your email address? (Example: john.doe@example.com)`,\n        `Perfect! What is your email address? (Example: john.doe@example.com)`,\n        `Excellent! What is your email address? (Example: john.doe@example.com)`,\n        `Wonderful! What is your email address? (Example: john.doe@example.com)`,\n        `Fantastic! What is your email address? (Example: john.doe@example.com)`,\n        `Great! What is your email address? (Example: john.doe@example.com)`,\n        `Perfect! What is your email address? (Example: john.doe@example.com)`,\n        `Excellent! What is your email address? (Example: john.doe@example.com)`,\n        `Wonderful! What is your email address? (Example: john.doe@example.com)`,\n        `Fantastic! What is your email address? (Example: john.doe@example.com)`\n      ];\n      \n      response = getRandomResponse(emailResponses);\n      nextState = 'waiting_for_email';\n      highlightedText = ['email address'];\n      quickActions = [];\n    } else {\n      // Get country-specific examples\n      const countryExamples = {\n        'US': '555-123-4567 or 5551234567',\n        'CA': '555-123-4567 or 5551234567',\n        'GB': '7700 900000 or 07700900000',\n        'AU': '4 1234 5678 or 0412345678',\n        'DE': '30 12345678 or 03012345678',\n        'FR': '1 23 45 67 89 or 0123456789',\n        'IN': '98765 43210 or 9876543210',\n        'JP': '90 1234 5678 or 09012345678',\n        'CN': '138 1234 5678 or 13812345678',\n        'BR': '11 98765 4321 or 11987654321',\n        'MX': '55 1234 5678 or 5512345678'\n      };\n      \n      const example = countryExamples[userCountry] || '555-123-4567 or 5551234567';\n      \n      const phoneClarificationResponses = [\n        `Please provide a valid phone number (e.g., ${example}).`,\n        `Could you give me a valid phone number (e.g., ${example})?`,\n        `I need a valid phone number (e.g., ${example}).`,\n        `Please share a valid phone number (e.g., ${example}).`,\n        `Could you provide a valid phone number (e.g., ${example})?`,\n        `I'd like a valid phone number (e.g., ${example}).`,\n        `Please give me a valid phone number (e.g., ${example}).`,\n        `Could you share a valid phone number (e.g., ${example})?`,\n        `I need a valid phone number (e.g., ${example}).`,\n        `Please provide a valid phone number (e.g., ${example}).`\n      ];\n      \n      response = getRandomResponse(phoneClarificationResponses);\n      nextState = 'waiting_for_phone';\n      quickActions = [];\n    }\n    break;\n    \n  case 'waiting_for_email':\n    // Validate email format\n    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n    if (emailPattern.test(message)) {\n      collectedData.email = message;\n      \n      // Handle missing or empty locations array\n      const locations = demoContext.locations && demoContext.locations.length > 0 \n        ? demoContext.locations.map((loc, index) => `${index + 1}. ${loc.city || loc}`).join('\\n')\n        : '1. Main Location';\n      \n      const locationResponses = [\n        `Perfect! Which location is more convenient for you?\\n\\n${locations}`,\n        `Great! Which location works best for you?\\n\\n${locations}`,\n        `Excellent! Which location would you prefer?\\n\\n${locations}`,\n        `Wonderful! Which location is most convenient for you?\\n\\n${locations}`,\n        `Fantastic! Which location suits you best?\\n\\n${locations}`,\n        `Perfect! Which location would work best for you?\\n\\n${locations}`,\n        `Great! Which location is most convenient?\\n\\n${locations}`,\n        `Excellent! Which location would you prefer?\\n\\n${locations}`,\n        `Wonderful! Which location works best for you?\\n\\n${locations}`,\n        `Fantastic! Which location is most convenient?\\n\\n${locations}`\n      ];\n      \n      response = getRandomResponse(locationResponses);\n      nextState = 'waiting_for_location';\n      highlightedText = ['location'];\n      quickActions = demoContext.locations && demoContext.locations.length > 0 \n        ? demoContext.locations.map((loc, index) => ({\n            text: loc.city || loc,\n            action: loc.city || loc\n          }))\n        : [{ text: 'Main Location', action: 'Main Location' }];\n    } else {\n      const emailClarificationResponses = [\n        `Please provide a valid email address (e.g., john.doe@example.com).`,\n        `Could you give me a valid email address (e.g., john.doe@example.com)?`,\n        `I need a valid email address (e.g., john.doe@example.com).`,\n        `Please share a valid email address (e.g., john.doe@example.com).`,\n        `Could you provide a valid email address (e.g., john.doe@example.com)?`,\n        `I'd like a valid email address (e.g., john.doe@example.com).`,\n        `Please give me a valid email address (e.g., john.doe@example.com).`,\n        `Could you share a valid email address (e.g., john.doe@example.com)?`,\n        `I need a valid email address (e.g., john.doe@example.com).`,\n        `Please provide a valid email address (e.g., john.doe@example.com).`\n      ];\n      \n      response = getRandomResponse(emailClarificationResponses);\n      nextState = 'waiting_for_email';\n      quickActions = [];\n    }\n    break;\n    \n  case 'waiting_for_location':\n    collectedData.location = message;\n    \n    const painLevelResponses = [\n      `Excellent! What is your pain level from 1 to 10?`,\n      `Great! What is your pain level from 1 to 10?`,\n      `Perfect! What is your pain level from 1 to 10?`,\n      `Wonderful! What is your pain level from 1 to 10?`,\n      `Fantastic! What is your pain level from 1 to 10?`,\n      `Excellent! What is your pain level from 1 to 10?`,\n      `Great! What is your pain level from 1 to 10?`,\n      `Perfect! What is your pain level from 1 to 10?`,\n      `Wonderful! What is your pain level from 1 to 10?`,\n      `Fantastic! What is your pain level from 1 to 10?`\n    ];\n    \n    response = getRandomResponse(painLevelResponses);\n    nextState = 'waiting_for_pain_level';\n    highlightedText = ['pain level from 1 to 10'];\n    quickActions = Array.from({length: 10}, (_, i) => ({\n      text: `${i + 1}`,\n      action: `${i + 1}`\n    }));\n    break;\n    \n  case 'waiting_for_pain_level':\n    collectedData.painLevel = message;\n    \n    const symptomsResponses = [\n      `Thank you. What symptoms are you experiencing?`,\n      `Thanks. What symptoms are you experiencing?`,\n      `Perfect. What symptoms are you experiencing?`,\n      `Great. What symptoms are you experiencing?`,\n      `Excellent. What symptoms are you experiencing?`,\n      `Thank you. What symptoms are you experiencing?`,\n      `Thanks. What symptoms are you experiencing?`,\n      `Perfect. What symptoms are you experiencing?`,\n      `Great. What symptoms are you experiencing?`,\n      `Excellent. What symptoms are you experiencing?`\n    ];\n    \n    response = getRandomResponse(symptomsResponses);\n    nextState = 'waiting_for_symptoms';\n    highlightedText = ['symptoms'];\n    quickActions = [];\n    break;\n    \n  case 'waiting_for_symptoms':\n    collectedData.symptoms = message;\n    \n    // Handle missing or empty services array\n    const services = demoContext.services && demoContext.services.length > 0 \n      ? demoContext.services.map((service, index) => `${index + 1}. ${service.name || service}`).join('\\n')\n      : '1. General Treatment';\n    \n    const procedureResponses = [\n      `What procedure are you interested in?\\n\\n${services}`,\n      `Which procedure interests you?\\n\\n${services}`,\n      `What procedure would you like to discuss?\\n\\n${services}`,\n      `Which procedure are you looking for?\\n\\n${services}`,\n      `What procedure are you considering?\\n\\n${services}`,\n      `Which procedure interests you most?\\n\\n${services}`,\n      `What procedure would you like to know about?\\n\\n${services}`,\n      `Which procedure are you interested in?\\n\\n${services}`,\n      `What procedure are you looking for?\\n\\n${services}`,\n      `Which procedure would you like to discuss?\\n\\n${services}`\n    ];\n    \n    response = getRandomResponse(procedureResponses);\n    nextState = 'waiting_for_procedure';\n    highlightedText = ['procedure'];\n    quickActions = demoContext.services && demoContext.services.length > 0 \n      ? demoContext.services.map((service, index) => ({\n          text: service.name || service,\n          action: service.name || service\n        }))\n      : [{ text: 'General Treatment', action: 'General Treatment' }];\n    break;\n    \n  case 'waiting_for_procedure':\n    collectedData.procedure = message;\n    \n    // Handle missing or empty insurance providers array\n    const insuranceProviders = demoContext.insuranceProviders && demoContext.insuranceProviders.length > 0 \n      ? demoContext.insuranceProviders.map((provider, index) => `${index + 1}. ${provider.name || provider}`).join('\\n')\n      : '1. Private Insurance\\n2. Other';\n    \n    const insuranceResponses = [\n      `What insurance do you have?\\n\\n${insuranceProviders}`,\n      `Which insurance provider do you have?\\n\\n${insuranceProviders}`,\n      `What insurance coverage do you have?\\n\\n${insuranceProviders}`,\n      `Which insurance do you carry?\\n\\n${insuranceProviders}`,\n      `What insurance plan do you have?\\n\\n${insuranceProviders}`,\n      `Which insurance provider do you use?\\n\\n${insuranceProviders}`,\n      `What insurance coverage do you carry?\\n\\n${insuranceProviders}`,\n      `Which insurance provider do you have?\\n\\n${insuranceProviders}`,\n      `What insurance plan do you carry?\\n\\n${insuranceProviders}`,\n      `Which insurance provider do you have?\\n\\n${insuranceProviders}`\n    ];\n    \n    response = getRandomResponse(insuranceResponses);\n    nextState = 'waiting_for_insurance';\n    highlightedText = ['insurance'];\n    quickActions = demoContext.insuranceProviders && demoContext.insuranceProviders.length > 0 \n      ? demoContext.insuranceProviders.map((provider, index) => ({\n          text: provider.name || provider,\n          action: provider.name || provider\n        }))\n      : [{ text: 'Private Insurance', action: 'Private Insurance' }, { text: 'Other', action: 'Other' }];\n    break;\n    \n  case 'waiting_for_insurance':\n    collectedData.insurance = message;\n    \n    const summaryResponses = [\n      `Thank you for providing all the information! I have collected:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Perfect! I've collected all the information:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Excellent! Here's what I have:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Wonderful! I've gathered all the details:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Fantastic! Here's the information I've collected:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Great! I have all the information:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Perfect! Here's what I've gathered:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Excellent! I've collected all the details:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Wonderful! Here's the information I have:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`,\n      \n      `Fantastic! I've gathered all the information:\\n\\n` +\n      `Name: ${collectedData.firstName} ${collectedData.lastName}\\n` +\n      `Date of Birth: ${collectedData.dateOfBirth}\\n` +\n      `Phone: ${collectedData.phone}\\n` +\n      `Email: ${collectedData.email}\\n` +\n      `Location: ${collectedData.location}\\n` +\n      `Pain Level: ${collectedData.painLevel}\\n` +\n      `Symptoms: ${collectedData.symptoms}\\n` +\n      `Procedure: ${collectedData.procedure}\\n` +\n      `Insurance: ${collectedData.insurance}\\n\\n` +\n      `Is there anything else you'd like to add?`\n    ];\n    \n    response = getRandomResponse(summaryResponses);\n    nextState = 'complete';\n    quickActions = [\n      { text: 'Yes, add more', action: 'add_more' },\n      { text: 'No, that\\'s all', action: 'complete' }\n    ];\n    break;\n    \n  default:\n    const defaultResponses = [\n      `I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to help you schedule an appointment. Would you like to start?`,\n      `Hello! I'm ${demoContext.agentName} from ${demoContext.companyName}. How can I assist you with scheduling an appointment?`,\n      `Hi there! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to help you book an appointment.`,\n      `Welcome! I'm ${demoContext.agentName} from ${demoContext.companyName}. How may I help you schedule an appointment?`,\n      `Greetings! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to assist with your appointment booking.`,\n      `Hello and welcome! I'm ${demoContext.agentName} from ${demoContext.companyName}. How can I help you schedule an appointment?`,\n      `Hi! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to support you with appointment scheduling.`,\n      `Good to see you! I'm ${demoContext.agentName} from ${demoContext.companyName}. How may I help you book an appointment?`,\n      `Welcome! I'm ${demoContext.agentName} from ${demoContext.companyName}. I'm here to help you schedule an appointment.`,\n      `Hello there! I'm ${demoContext.agentName} from ${demoContext.companyName}. How can I assist you with your appointment?`\n    ];\n    \n    response = getRandomResponse(defaultResponses);\n    nextState = 'initial';\n    quickActions = [\n      { text: 'Schedule Appointment', action: 'schedule' }\n    ];\n    break;\n}\n\nconsole.log(' Next State:', nextState);\nconsole.log('üîß Response:', response);\nconsole.log('üîß Final Collected Data:', collectedData);\nconsole.log('üîß Quick Actions:', quickActions);\n\nreturn [{\n  \"json\": {\n    \"message\": response,\n    \"currentState\": nextState,\n    \"collectedData\": collectedData,\n    \"highlightedText\": highlightedText,\n    \"demoContext\": demoContext,\n    \"bookingState\": nextState,\n    \"bookingData\": collectedData,\n    \"quickActions\": quickActions,\n    \"timestamp\": new Date().toISOString()\n  },\n  \"pairedItem\": 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        -48
      ],
      "id": "084d717a-ed8d-4975-957c-d985b8870de5",
      "name": "Complete State Manager"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.operation }}",
              "value2": "store"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -16,
        -64
      ],
      "id": "6c0b24f5-6cad-4b4f-9747-8dd89429a691",
      "name": "If Operation"
    },
    {
      "parameters": {
        "jsCode": "// Shared Context Storage - PERMANENT SOLUTION\nconst input = $input.first().json;\nconst operation = input.operation || 'get';\nconst demoId = input.demoId || input.demo_id || '';\nconst demoContext = input.demoContext || {};\nconst message = input.message || '';\nconst currentState = input.currentState || 'initial';\nconst collectedData = input.collectedData || {};\nconst bookingState = input.bookingState || '';\nconst bookingData = input.bookingData || {};\n\nconsole.log('üè™ Shared Context Storage - Operation:', operation);\nconsole.log('üè™ Demo ID:', demoId);\n\nif (operation === 'store') {\n  // Store demo context - but we'll pass it through the workflow instead\n  if (!demoId) {\n    console.log('‚ùå No demo ID provided for storage');\n    return [{\n      \"json\": {\n        \"success\": false,\n        \"error\": \"No demo ID provided\",\n        \"timestamp\": new Date().toISOString()\n      },\n      \"pairedItem\": 0\n    }];\n  }\n  \n  if (!demoContext.companyName) {\n    console.log('‚ùå No demo context provided for storage');\n    return [{\n      \"json\": {\n        \"success\": false,\n        \"error\": \"No demo context provided\",\n        \"timestamp\": new Date().toISOString()\n      },\n      \"pairedItem\": 0\n    }];\n  }\n  \n  console.log('üíæ Demo context received for demo ID:', demoId);\n  console.log('üè¢ Company:', demoContext.companyName);\n  console.log('üë§ Agent:', demoContext.agentName);\n  \n  // PASS THE CONTEXT THROUGH THE WORKFLOW\n  return [{\n    \"json\": {\n      \"success\": true,\n      \"operation\": \"store\",\n      \"demoId\": demoId,\n      \"demoContext\": demoContext, // PASS THE CONTEXT FORWARD\n      \"storedAt\": new Date().toISOString(),\n      \"message\": \"Demo context stored successfully\"\n    },\n    \"pairedItem\": 0\n  }];\n  \n} else if (operation === 'get') {\n  // Retrieve demo context - PASS THROUGH THE CONTEXT FROM INPUT\n  if (!demoId) {\n    console.log('‚ùå No demo ID provided for retrieval');\n    return [{\n      \"json\": {\n        \"success\": false,\n        \"error\": \"No demo ID provided\",\n        \"message\": message,\n        \"demoContext\": null\n      },\n      \"pairedItem\": 0\n    }];\n  }\n  \n  // PERMANENT SOLUTION: Pass through the demo context from the input\n  console.log('üîç Processing get operation for demo ID:', demoId);\n  console.log('üè¢ Demo context from input:', demoContext.companyName);\n  \n  return [{\n    \"json\": {\n      \"success\": true,\n      \"operation\": \"get\",\n      \"demoId\": demoId,\n      \"message\": message,\n      \"demoContext\": demoContext, // CRITICAL: Pass through the context from input\n      \"currentState\": currentState,\n      \"collectedData\": collectedData,\n      \"bookingState\": bookingState,\n      \"bookingData\": bookingData,\n      \"timestamp\": new Date().toISOString(),\n      \"source\": \"workflow_flow\"\n    },\n    \"pairedItem\": 0\n  }];\n}\n\n// Invalid operation\nconsole.log('‚ùå Invalid operation:', operation);\nreturn [{\n  \"json\": {\n    \"success\": false,\n    \"error\": \"Invalid operation. Use \\\"store\\\" or \\\"get\\\"\",\n    \"timestamp\": new Date().toISOString()\n  },\n  \"pairedItem\": 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        -64
      ],
      "id": "42723231-81e0-4f6e-905d-146e78471069",
      "name": "Shared Context Storage"
    },
    {
      "parameters": {
        "jsCode": "// Chat Handler - Prepare data for shared storage retrieval\nconst input = $input.first().json;\n\nconsole.log('üí¨ Chat Handler - Input:', JSON.stringify(input, null, 2));\n\n// Extract chat data from the webhook payload\nconst message = input.body?.message || '';\nconst demoId = input.body?.demoId || input.body?.demo_id || '';\nconst currentState = input.body?.currentState || 'initial';\nconst collectedData = input.body?.collectedData || {};\nconst bookingState = input.body?.bookingState || '';\nconst bookingData = input.body?.bookingData || {};\n\n// CRITICAL FIX: Extract demo context from the webhook body\nlet demoContext = {};\nif (input.body?.demoContext) {\n  // Use the demo context directly from the webhook body\n  demoContext = input.body.demoContext;\n  console.log('‚úÖ Using demo context from webhook body:', demoContext.companyName);\n} else if (input.body?.config?.branding) {\n  demoContext = {\n    companyName: input.body.config.branding.companyName || '',\n    agentName: input.body.config.agentName || '',\n    locations: input.body.config.branding.locations || [],\n    services: input.body.config.branding.categories || [],\n    insuranceProviders: input.body?.config?.branding?.insuranceProviders || input.body?.userContext?.insuranceProviders || []\n  };\n} else if (input.body?.userContext) {\n  demoContext = {\n    companyName: input.body.userContext.companyName || '',\n    agentName: input.body.userContext.agentName || '',\n    locations: [],\n    services: [],\n    insuranceProviders: input.body?.userContext?.insuranceProviders || []\n  };\n}\n\nconsole.log('üí¨ Extracted data:');\nconsole.log('ÔøΩÔøΩ Message:', message);\nconsole.log('üÜî Demo ID:', demoId);\nconsole.log('üîÑ Current State:', currentState);\nconsole.log('üìä Collected Data:', Object.keys(collectedData));\nconsole.log('üìÖ Booking State:', bookingState);\nconsole.log('üìã Booking Data:', Object.keys(bookingData));\nconsole.log('üè¢ Demo Context:', demoContext.companyName);\nconsole.log('ÔøΩÔøΩ Agent Name:', demoContext.agentName);\n\nif (!demoId) {\n  console.log('‚ùå No demo ID provided for chat');\n  return [{\n    \"json\": {\n      \"success\": false,\n      \"error\": \"No demo ID provided\",\n      \"message\": message\n    },\n    \"pairedItem\": 0\n  }];\n}\n\n// Prepare data for shared storage retrieval\nreturn [{\n  \"json\": {\n    \"operation\": \"get\",\n    \"demoId\": demoId,\n    \"message\": message,\n    \"demoContext\": demoContext, // CRITICAL: Include the demo context\n    \"currentState\": currentState,\n    \"collectedData\": collectedData,\n    \"bookingState\": bookingState,\n    \"bookingData\": bookingData,\n    \"timestamp\": new Date().toISOString()\n  },\n  \"pairedItem\": 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        32
      ],
      "id": "e95dabff-bf75-41dd-a26b-4cffefdffd4c",
      "name": "Chat Handler"
    },
    {
      "parameters": {
        "jsCode": "// Demo Creation Handler - Prepare data for shared storage\nconst input = $input.first().json;\n\nconsole.log('üéØ Demo Creation Handler - Input:', JSON.stringify(input, null, 2));\n\n// Extract demo context from the webhook payload\nconst webhookBody = input.body || {};\nconst demoContext = webhookBody.demoContext || {};\nconst demoId = webhookBody.demoId || webhookBody.demo_id || '';\n\nconsole.log('üéØ Webhook Body:', JSON.stringify(webhookBody, null, 2));\nconsole.log('üéØ Demo ID from body:', demoId);\nconsole.log('üéØ Demo Context from body:', JSON.stringify(demoContext, null, 2));\n\nif (!demoId) {\n  console.log('‚ùå No demo ID provided');\n  return [{\n    \"json\": {\n      \"success\": false,\n      \"error\": \"No demo ID provided\",\n      \"timestamp\": new Date().toISOString()\n    },\n    \"pairedItem\": 0\n  }];\n}\n\nif (!demoContext.companyName) {\n  console.log('‚ùå No demo context provided');\n  return [{\n    \"json\": {\n      \"success\": false,\n      \"error\": \"No demo context provided\",\n      \"timestamp\": new Date().toISOString()\n    },\n    \"pairedItem\": 0\n  }];\n}\n\nconsole.log('‚úÖ Demo creation data prepared for storage:');\nconsole.log('üè¢ Company:', demoContext.companyName);\nconsole.log('üë§ Agent:', demoContext.agentName);\nconsole.log('üÜî Demo ID:', demoId);\n\n// Prepare data for shared storage\nreturn [{\n  \"json\": {\n    \"operation\": \"store\",\n    \"demoId\": demoId,\n    \"demoContext\": demoContext,\n    \"timestamp\": new Date().toISOString()\n  },\n  \"pairedItem\": 0\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -176
      ],
      "id": "a5fda1f8-d1f9-4ba4-9ec9-01c566cf8fff",
      "name": "Demo Creation Handler"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "demo-chat-universal",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -608,
        32
      ],
      "id": "b3ab4f1d-8202-4c2e-a0c8-8e0990e3dbf7",
      "name": "Chat Webhook",
      "path": "demo-chat-universal",
      "webhookId": "759b2af5-194d-4b63-a1bb-1a51780d43ab"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "demo-creation-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -608,
        -176
      ],
      "id": "1bfed2cf-0bfa-44f6-aecb-3360e1298110",
      "name": "Demo Creation Webhook",
      "webhookId": "c280effa-983e-445a-8512-47b3490570c1"
    }
  ],
  "pinData": {},
  "connections": {
    "Complete State Manager": {
      "main": [
        [
          {
            "node": "Chat Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Operation": {
      "main": [
        [
          {
            "node": "Demo Creation Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Complete State Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Shared Context Storage": {
      "main": [
        [
          {
            "node": "If Operation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Handler": {
      "main": [
        [
          {
            "node": "Shared Context Storage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Demo Creation Handler": {
      "main": [
        [
          {
            "node": "Shared Context Storage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Webhook": {
      "main": [
        [
          {
            "node": "Chat Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Demo Creation Webhook": {
      "main": [
        [
          {
            "node": "Demo Creation Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "63b105ee-13e3-4bdb-afbd-65e1136ac588",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "abf67c2e1677bdd3ef317dd0650cb7b5409ada606c4b9975045aaecf5f5d963a"
  },
  "id": "eDCfrR4dDBKl2rsx",
  "tags": [
    {
      "createdAt": "2025-08-19T21:59:52.564Z",
      "updatedAt": "2025-08-19T21:59:52.564Z",
      "id": "Dm64aICzBgn2KhjO",
      "name": "Healthcare"
    },
    {
      "createdAt": "2025-08-27T20:24:18.590Z",
      "updatedAt": "2025-08-27T20:24:18.590Z",
      "id": "I3GveIcTop7B94oU",
      "name": "Healthcare Demo"
    },
    {
      "createdAt": "2025-08-27T19:29:14.623Z",
      "updatedAt": "2025-08-27T19:29:14.623Z",
      "id": "Lvt1iHFU60UYeJfk",
      "name": "White Label"
    },
    {
      "createdAt": "2025-08-19T22:00:09.410Z",
      "updatedAt": "2025-08-19T22:00:09.410Z",
      "id": "MWgjiX5NOhIzqXXW",
      "name": "Sports Medicine"
    },
    {
      "createdAt": "2025-08-27T19:29:14.648Z",
      "updatedAt": "2025-08-27T19:29:14.648Z",
      "id": "i6r7sjlqH2UvKZzJ",
      "name": "Dynamic Context"
    },
    {
      "createdAt": "2025-08-27T19:29:14.606Z",
      "updatedAt": "2025-08-27T19:29:14.606Z",
      "id": "nlBZzXj61fewu2Dq",
      "name": "Universal Demo"
    },
    {
      "createdAt": "2025-08-19T22:00:02.310Z",
      "updatedAt": "2025-08-19T22:00:02.310Z",
      "id": "oe3QA0k1pbUWX9gL",
      "name": "Pain Management"
    }
  ]
}